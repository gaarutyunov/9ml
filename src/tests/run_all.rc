#!/bin/rc
# Run all tests in Plan 9 and save outputs to /mnt/host

cd /mnt/host

# Test rmsnorm
echo 'Compiling test_rmsnorm...'
6c -w test_rmsnorm.c && 6l -o test_rmsnorm test_rmsnorm.6
./test_rmsnorm > test_rmsnorm.out >[2=1]
echo 'rmsnorm done'

# Test softmax
echo 'Compiling test_softmax...'
6c -w test_softmax.c && 6l -o test_softmax test_softmax.6
./test_softmax > test_softmax.out >[2=1]
echo 'softmax done'

# Test matmul
echo 'Compiling test_matmul...'
6c -w test_matmul.c && 6l -o test_matmul test_matmul.6
./test_matmul > test_matmul.out >[2=1]
echo 'matmul done'

# Test rng
echo 'Compiling test_rng...'
6c -w test_rng.c && 6l -o test_rng test_rng.6
./test_rng > test_rng.out >[2=1]
echo 'rng done'

# Test model_loading (needs model file)
if(test -f stories15M.bin) {
    echo 'Compiling test_model_loading...'
    6c -w test_model_loading.c && 6l -o test_model_loading test_model_loading.6
    ./test_model_loading > test_model_loading.out >[2=1]
    echo 'model_loading done'
}

# Test quantize
echo 'Compiling test_quantize...'
6c -w test_quantize.c && 6l -o test_quantize test_quantize.6
./test_quantize > test_quantize.out >[2=1]
echo 'quantize done'

# Test quantized_matmul
echo 'Compiling test_quantized_matmul...'
6c -w test_quantized_matmul.c && 6l -o test_quantized_matmul test_quantized_matmul.6
./test_quantized_matmul > test_quantized_matmul.out >[2=1]
echo 'quantized_matmul done'

# Full generation test (if model and tokenizer exist)
if(test -f stories15M.bin && test -f tokenizer.bin) {
    echo 'Compiling run.c for generation test...'
    6c -w run.c && 6l -o run run.6
    ./run stories15M.bin -z tokenizer.bin -n 20 -s 42 -i 'Once upon a time' > generation.out >[2=1]
    echo 'generation done'
}

echo 'ALL TESTS COMPLETE'
