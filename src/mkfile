</$objtype/mkfile

TARG=run runq export llmfs

# SIMD assembly files for amd64
SIMD_ASM=simd_amd64.$O simdq_amd64.$O

# Architecture plugin library
ARCH_LIB=arch/arch.a$O

# New multi-model library directories
SUBDIRS=core arch

all:V: libs $TARG

# Build libraries in subdirectories
libs:V:
	for(d in $SUBDIRS) @{
		cd $d && mk
	}

# run and runq need SIMD assembly and arch plugins linked
run: run.$O $SIMD_ASM $ARCH_LIB
	$LD -o $target $prereq

runq: runq.$O $SIMD_ASM
	$LD -o $target $prereq

export: export.$O
	$LD -o $target $prereq

# Download modules for llmfs
DOWNLOAD_OBJ=download/http.$O download/hfhub.$O

# llmfs requires lib9p, libthread, arch plugins, and download modules
llmfs: llmfs.$O $SIMD_ASM $ARCH_LIB $DOWNLOAD_OBJ
	$LD -o $target $prereq

# Compile download modules
download/http.$O: download/http.c download/http.h
	$CC $CFLAGS -Idownload download/http.c
	mv http.$O download/

download/hfhub.$O: download/hfhub.c download/hfhub.h download/http.h
	$CC $CFLAGS -Idownload download/hfhub.c
	mv hfhub.$O download/

# C source compilation
%.$O: %.c
	$CC $CFLAGS $stem.c

# Assembly compilation (Plan 9 assembler)
simd_amd64.$O: simd_amd64.s
	$AS simd_amd64.s

simdq_amd64.$O: simdq_amd64.s
	$AS simdq_amd64.s

clean:V:
	rm -f *.$O $TARG
	for(d in $SUBDIRS) @{
		cd $d && mk clean
	}
